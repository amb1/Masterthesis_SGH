description: Regeln für die Verarbeitung von WFS-Diensten
globs: ["pipeline/data_sources/wfs_fetcher.py", "tests/data_sources/test_wfs_fetcher.py"]
alwaysApply: true

# Vienna Web Feature Service (WFS) Integration

## Konfiguration

### Dienst-Einstellungen
```yaml
vienna_wfs:
  url: "https://data.wien.gv.at/daten/geo"
  version: "1.1.0"
  srsName: "EPSG:31256"  # Wiener Koordinatensystem
  timeout: 30
  retries: 3
```

### Streams
```yaml
streams:
  - name: "Gebäudeinfo"
    layer: "ogdwien:GEBAEUDEINFOOGD"
    priority: 1
    fields:
      - "OBJECTID"
      - "geometry"
      - "BAUJAHR"
    mapping:
      building_id: "OBJECTID"
      geometry: "geometry"
      construction_year: "BAUJAHR"
```

## Implementierung

### ViennaWFS-Klasse
- Initialisierung mit Konfiguration
- Stream-basierte Verarbeitung
- Räumliche Filter (BBOX)
- CRS-Transformation
- Detailliertes Logging

### Hauptfunktionen
```python
def process_site(site_polygon: gpd.GeoDataFrame) -> Dict[str, gpd.GeoDataFrame]:
    """Verarbeitet alle WFS-Streams für ein Site-Polygon"""
    # CRS-Transformation
    # BBOX-Extraktion
    # Stream-Verarbeitung nach Priorität
    # Clipping auf Site-Polygon
    # Mapping und Transformation
```

### Fehlerbehandlung
- Verbindungsfehler
- Ungültige Layer
- CRS-Transformationsfehler
- XML-Entity-Handling

## Test-Strategie

### Fixtures
```python
@pytest.fixture
def sample_config():
    """Test-Konfiguration für Vienna WFS"""
    return {
        'url': 'https://data.wien.gv.at/daten/geo',
        'version': '1.1.0',
        'srsName': 'EPSG:31256',
        'streams': [...]
    }
```

### Testfälle
- Initialisierung
- BBOX-Formatierung
- Layer-Abruf
- Site-Verarbeitung
- Fehlerbehandlung

## Performance

### Optimierungen
- Priorisierte Stream-Verarbeitung
- Effizientes Clipping
- Intelligentes Mapping

### Logging
- Detaillierte Statusmeldungen
- Fehlerprotokollierung
- Performance-Metriken

## Export

### GeoJSON
- Stream-basierter Export
- CRS-Handling
- Attribut-Mapping

### Shapefile
- Zwischenspeicherung
- Attribut-Konvertierung
- Kodierung 